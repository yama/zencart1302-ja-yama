<?php
//
// +----------------------------------------------------------------------+
// |zen-cart Open Source E-commerce                                       |
// +----------------------------------------------------------------------+
// | Copyright (c) 2003 The zen-cart developers                           |
// |                                                                      |
// | http://www.zen-cart.com/index.php                                    |
// |                                                                      |
// | Portions Copyright (c) 2003 osCommerce                               |
// +----------------------------------------------------------------------+
// | This source file is subject to version 2.0 of the GPL license,       |
// | that is bundled with this package in the file LICENSE, and is        |
// | available through the world-wide-web at the following url:           |
// | http://www.zen-cart.com/license/2_0.txt.                             |
// | If you did not receive a copy of the zen-cart license and are unable |
// | to obtain it through the world-wide-web, please send a note to       |
// | license@zen-cart.com so we can mail you a copy immediately.          |
// +----------------------------------------------------------------------+
// $Id$
// 
// ╗┘╩зддете╕ехб╝еы епеэе═е│бўе┌едесеєе╚
//
// ║ю╝╘
// ═н╕┬▓ё╝╥е╙е├е░е▐еже╣бб║┤б╣╠┌бб╣ф╝г
// sasaki@bigmouse.jp
// http://www.bigmouse.jp
//
// 
// ╣╣┐╖═·╬Є
// 2005/03/21
// бж║╟─у┼м═╤╢т│█дЄ└▀─ъд╟дндыдшджд╦д╖д▐д╖д┐бг
// 
// 
// е╤е├е▒б╝е╕д╬╞т═╞ ----------------------------------------------------
// 
// бжепеэе═е│@е┌едесеєе╚ете╕ехб╝еыепеще╣е╒ебедеы
// includes/modules/payment/kuroneko_at_payment.php
// 
// бжепеэе═е│@е┌едесеєе╚ете╕ехб╝еы╕└╕ье╒ебедеыб╩japaneseб╦
// includes/languages/japanese/modules/payment/kuroneko_at_payment.php
// 
// бжепеэе═е│@е┌едесеєе╚еъеєепе▄е┐еє▓ш┴№е╒ебедеыб╩japaneseб╦
// includes/templates/template_default/buttons/japanese/button_kuroneko_at_payment.gif
// 
// бжtpl_checkout_success_default.phpе╞еєе╫еьб╝е╚е╒ебедеы╜д└╡╬у
// includes/templates/template_default/templates/tpl_checkout_success_default.php
// бб$,1s;(B23╣╘╠▄д╦ < ?php if (isset($_SESSION['kuroneko_at_payment'])) echo $_SESSION['kuroneko_at_payment']['box']; ? >ббдЄ┴▐╞■
// 
// ----------------------------------------------------------------------
// 
// 
// ├э╩╕│╬╟з╕хбв$_SESSION['kuroneko_at_payment']ббд╦еъеєепе▄е┐еєд╬HTMLе╜б╝е╣дм
// ╟█╬єд╟┬х╞■д╡дьд▐д╣бг
// 
// ╟█╬єд╬╞т═╞
// $_SESSION['kuroneko_at_payment']['link_button'] ббеъеєепе▄е┐еєд╬д▀д╬htmlе╜б╝е╣
// $_SESSION['kuroneko_at_payment']['text_urge']бб╖ш║╤╝ъ┬│днд╪┬ед╣╩╕╛╧д╬htmlе╜б╝е╣
// $_SESSION['kuroneko_at_payment']['box']бб╛х╡нг▓д─дЄ┤▐дрplainBoxд╬htmlе╜б╝е╣
// 
// includes/templates/template_default/templates/tpl_checkout_success_default.phpбб╞тд╟
// ╔м═╫д╩е╜б╝е╣дЄechoд╣ды
// 
// ╬уб╦епеэе═е│бўе┌едесеєе╚╖ш║╤д╪д╬е▄е├епе╣д╬╔╜╝и
// < ?php if (isset($_SESSION['kuroneko_at_payment'])) echo $_SESSION['kuroneko_at_payment']['box'];  ? >
// 
// ----------------------------------------------------------------------
// 
// 
// 
// ете╕ехб╝еы└▀─ъ -------------------------------------------------------
// 
// бжепеэе═е│бўе┌едесеєе╚ете╕ехб╝еыдЄ═н╕·д╦д╣ды
// ббббTrueбббжбжбж ═н╕·
// ббббFalse бжбжбж ╠╡╕·
// ббббе╟е╒ейеые╚├═ббTrue
// 
// бж╦▄╚╓е┌б╝е╕д╪д╬└┌┬╪ди
// ббббTrueбббжбжбж ╦▄┼Ўд╬╖ш║╤е┌б╝е╕д╪д─д╩дмдъд▐д╣бг
// ббббFalse бжбжбж ╞░║юе╞е╣е╚═╤д╬е┌б╝е╕д╦д─д╩дмдъд▐д╣бг
// бббб$,1s;(B ╦▄╚╓▓╘╞░д╬┴░д╦╞░║юе╞е╣е╚═╤д╬е┌б╝е╕д╟╜╜╩ме╞е╣е╚д╖д╞дпд└д╡ддбг
// ббббе╟е╒ейеые╚├═ббFalse
// 
// бж▓├╠┴┼╣е│б╝е╔
// бббб▓├╠┴┼╣е│б╝е╔дЄ╚╛│╤┐Ї╗·д╟╞■╬╧д╖д▐д╣бг
// ббббе╟е╒ейеые╚├═бб╢ї═є
// 
// бж║╟─у╢т│█
// ббббепеэе═е│бўе┌едесеєе╚дЄ┼м═╤д╣ды║╟─у╢т│█дЄ╞■╬╧д╖д▐д╣бг
// бббб╞т└╟│░└╟д╬╖╫╗╗д╦┤╪╖╕д╩дпелб╝е╚д╬╛о╖╫дм╞■╬╧д╖д┐╢т│█░╩╛хд╟
// бббб╔╜╝ид╡дьд▐д╣бг
// ббббе╟е╒ейеые╚├═бб0
// 
// бж┴ў┐о└шURL
// ббббеъеєепе▄е┐еєб╩е╒ейб╝ерб╦д╬┴ў┐о└шд╬URLдЄ╞■╬╧д╖д▐д╣бг
// ббббе╟е╒ейеые╚├═ббhttps://payment.kuronekoyamato.co.jp/kuroneko/servlet/YCS_ServletC
// 
// бжепеэе═е│бўе┌едесеєе╚еъеєепе╨е╩б╝
// ббббдк╗┘╩здд╩¤╦б┴к┬Єе┌б╝е╕д╟епеэе═е│бўе┌едесеєе╚д╬└т╠└е┌б╝е╕д╪д╬еъеєепе╨е╩б╝д╬е╜б╝е╣дЄ
// бббб╞■╬╧д╖д╞дпд└д╡ддбгеъеєепе╨е╩б╝д╬е╜б╝е╣д╧епеэе═е│бўе┌едесеєе╚д╬WEBе╡еде╚длдщ╞■╝ъ
// бббб╜╨═шд▐д╣бг
// ббббе╟е╒ейеые╚├═бб<a href="http://payment.kuronekoyamato.co.jp/help/hanbai/card.html" target="_blank"><img src=http://payment.kuronekoyamato.co.jp/help/images/payment04.gif width="50" height="50" border="0" alt="епеэе═е│бўе┌едесеєе╚"></a>
// 
// бж┼м═╤├╧░ш
// бббб╞№╦▄░╩│░д╬├╧░шдм┴к┬Є▓─╟╜д╦д╩д├д╞ддд▐д╣дм╔мд║╞№╦▄дЄ┴к┬Єд╖д╞дпд└д╡ддбг
// ббббе╟е╒ейеые╚├═бб╞№╦▄
// 
// бж╜щ┤№├э╩╕е╣е╞б╝е┐е╣
// бббб├э╩╕│╬╟з┤░╬╗╕хд╬├э╩╕е╣е╞б╝е┐е╣дЄ┴к┬Єд╖д╞дпд└д╡ддбг
// ббббе╟е╒ейеые╚├═ббе╟е╒ейеые╚
// 
// бж╔╜╝ид╬└░╬є╜ч
// ббббдк╗┘╩здд╩¤╦б┴к┬Єе┌б╝е╕д╟д╬╔╜╝ид╬└░╬є╜чдЄ└▀─ъд╟днд▐д╣бг┐Ї╗·дм╛од╡ддд█д╔╛х░╠д╦╔╜╝ид╡дьд▐д╣бг
// ббббе╟е╒ейеые╚├═бб0
// 
// ----------------------------------------------------------------------
//
// [╗▓╛╚]
// http://www.zen-cart.jp/bbs/7/tree.php?all=126
// http://www.zen-cart.jp/bbs/7/tree.php?all=166
// http://www.zen-cart.jp/bbs/7/tree.php?all=230

  class kuroneko_at_payment {
    var $code, $title, $description, $enabled;

// class constructor
    function kuroneko_at_payment() {
      global $order;
      if (isset($_SESSION['kuroneko_at_payment'])) {
        unset($_SESSION['kuroneko_at_payment']);
      }
      $this->code = 'kuroneko_at_payment';
      $this->title = MODULE_PAYMENT_KURONEKO_AT_PAYMENT_TEXT_TITLE;
      $this->description = MODULE_PAYMENT_KURONEKO_AT_PAYMENT_TEXT_DESCRIPTION;
      $this->sort_order = MODULE_PAYMENT_KURONEKO_AT_PAYMENT_SORT_ORDER;
      $this->enabled = ((MODULE_PAYMENT_KURONEKO_AT_PAYMENT_STATUS == 'True') ? true : false);

      if ((int)MODULE_PAYMENT_KURONEKO_AT_PAYMENT_ORDER_STATUS_ID > 0) {
        $this->order_status = MODULE_PAYMENT_KURONEKO_AT_PAYMENT_ORDER_STATUS_ID;
      }

      if (is_object($order)) $this->update_status();

    }

// class methods
    function update_status() {
      global $order, $db;

      if ( ($this->enabled == true) && ((int)MODULE_PAYMENT_KURONEKO_AT_PAYMENT_ZONE > 0) ) {
        $check_flag = false;
        $check = $db->Execute("select zone_id from " . TABLE_ZONES_TO_GEO_ZONES . " where geo_zone_id = '" . MODULE_PAYMENT_KURONEKO_AT_PAYMENT_ZONE . "' and zone_country_id = '" . $order->delivery['country']['id'] . "' order by zone_id");
        while (!$check->EOF) {
          if ($check->fields['zone_id'] < 1) {
            $check_flag = true;
            break;
          } elseif ($check->fields['zone_id'] == $order->delivery['zone_id']) {
            $check_flag = true;
            break;
          }
          $check->MoveNext();
        }

        $total_price = $_SESSION['cart']->show_total();
        if ($total_price < MODULE_PAYMENT_KURONEKO_AT_PAYMENT_MINIMUM_TOTAL_PRICE) {
          $check_flag = false;
        }

        if ($check_flag == false) {
          $this->enabled = false;
        }
      }

// disable the module if the order only contains virtual products
      if ($this->enabled == true) {
        if ($order->content_type != 'physical') {
          $this->enabled = false;
        }
      }
    }

    function javascript_validation() {
      return false;
    }

    function selection() {
      return array('id' => $this->code,
                   'module' => $this->title,
                   'fields' => array(array('title' => MODULE_PAYMENT_KURONEKO_AT_PAYMENT_TEXT_ABOUT,
                                                      'field' => MODULE_PAYMENT_KURONEKO_AT_PAYMENT_LINK_BANNER)));
    }

    function pre_confirmation_check() {
      return false;
    }

    function confirmation() {
      return array('title' => MODULE_PAYMENT_KURONEKO_AT_PAYMENT_TEXT_CONFIRMATION);
    }

    function process_button() {
      return false;
    }

    function before_process() {
      return false;
    }

    function after_process() {
      global $db;
      $orders_query = "select orders_id, billing_name, order_total, billing_telephone, customers_email_address from " . TABLE_ORDERS . "
                       where customers_id = '" . (int)$_SESSION['customer_id'] . "'
                       order by date_purchased desc limit 1";

      $orders = $db->Execute($orders_query);

      $products_array = array();

      $products_query = "select products_id, products_name, products_quantity from " . TABLE_ORDERS_PRODUCTS . "
                         where orders_id = '" . (int)$orders->fields['orders_id'] . "'
                         order by products_name";

      $products = $db->Execute($products_query);
      $leading_product_name = sprintf(MODULE_PAYMENT_KURONEKO_AT_PAYMENT_LEADING_PRODUCT, $products->fields['products_name'], (int)$products->fields['products_quantity']);
      $products_count = $products->RecordCount();
      $total_products_quantity = 0;
      $products->MoveNext();
      while (!$products->EOF) {
        $other_products_quantity = $other_products_quantity + (int)$products->fields['products_quantity'];
        $products->MoveNext();
      }

      $action = MODULE_PAYMENT_KURONEKO_AT_PAYMENT_ACTION_URL;
      if (MODULE_PAYMENT_KURONEKO_AT_PAYMENT_NO_TEST == 'True') {
        $trs_map = 'V_W02';
      } else {
        $trs_map = 'L_TEST';
      }
      $trader_code = MODULE_PAYMENT_KURONEKO_AT_PAYMENT_TRADER_CODE;
      $order_no = (int)$orders->fields['orders_id'];
      $goods_name = $leading_product_name;
      if ($other_products_quantity > 0) {
       $goods_name .= sprintf(MODULE_PAYMENT_KURONEKO_AT_PAYMENT_OTHER_PRODUCTS, $other_products_quantity);
      }
      $settle_price = (int)$orders->fields['order_total'];
      $buyer_name_kanji = $orders->fields['billing_name'];
      $buyer_tel = $orders->fields['billing_telephone'];
      $buyer_email = $orders->fields['customers_email_address'];
      $button_image = MODULE_PAYMENT_KURONEKO_AT_PAYMENT_BUTTON_IMAGE;
      $button_alt = MODULE_PAYMENT_KURONEKO_AT_PAYMENT_BUTTON_ALT;

      $link_button .= zen_draw_form('UserForm', $action, 'post', 'target="_blank"') . "\n";
      $link_button .= zen_draw_hidden_field('TRS_MAP', $trs_map) . "\n";
      $link_button .= zen_draw_hidden_field('trader_code', $trader_code) . "\n";
      $link_button .= zen_draw_hidden_field('order_no', $order_no) . "\n";
      $link_button .= zen_draw_hidden_field('goods_name', $goods_name) . "\n";
      $link_button .= zen_draw_hidden_field('settle_price', $settle_price) . "\n";
      $link_button .= zen_draw_hidden_field('buyer_name_kanji', $buyer_name_kanji) . "\n";
      $link_button .= zen_draw_hidden_field('buyer_tel', $buyer_tel) . "\n";
      $link_button .= zen_draw_hidden_field('buyer_email', $buyer_email) . "\n";
      $link_button .= zen_image_submit($button_image, $button_alt) . "\n";
      $link_button .= "</form>\n";

      $text_urge = MODULE_PAYMENT_KURONEKO_AT_PAYMENT_TEXT_URGE;

      $box = "<table  width=\"100%\" border=\"0\" cellspacing=\"2\" cellpadding=\"2\">\n";
      $box .= "  <tr>\n";
      $box .= "    <td class=\"plainBox\" align=\"center\">" . MODULE_PAYMENT_KURONEKO_AT_PAYMENT_TEXT_URGE . "<br />\n";
      $box .= $link_button;
      $box .= "    </td>\n";
      $box .= "  </tr>\n";
      $box .= "</table>\n";

      $kuroneko_at_payment = array('link_button' => $link_button,'text_urge' => $text_urge,'box' => $box);
      $_SESSION['kuroneko_at_payment'] = $kuroneko_at_payment;
    }

    function get_error() {
      return false;
    }

    function check() {
      global $db;
      if (!isset($this->_check)) {
        $check_query = $db->Execute("select configuration_value from " . TABLE_CONFIGURATION . " where configuration_key = 'MODULE_PAYMENT_KURONEKO_AT_PAYMENT_STATUS'");
        $this->_check = $check_query->RecordCount();
      }
      return $this->_check;
    }

    function install() {
      global $db;
      $db->Execute("insert into " . TABLE_CONFIGURATION . " (configuration_title, configuration_key, configuration_value, configuration_description, configuration_group_id, sort_order, set_function, date_added) values ('епеэе═е│бўе┌едесеєе╚ете╕ехб╝еыдЄ═н╕·д╦д╣ды', 'MODULE_PAYMENT_KURONEKO_AT_PAYMENT_STATUS', 'True', 'епеэе═е│бўе┌едесеєе╚дЄ╝їд▒╔╒д▒д▐д╣длбй', '6', '1', 'zen_cfg_select_option(array(\'True\', \'False\'), ', now())");
      $db->Execute("insert into " . TABLE_CONFIGURATION . " (configuration_title, configuration_key, configuration_value, configuration_description, configuration_group_id, sort_order, set_function, date_added) values ('╦▄╚╓е┌б╝е╕д╪д╬└┌┬╪ди', 'MODULE_PAYMENT_KURONEKO_AT_PAYMENT_NO_TEST', 'False', '╦▄╚╓е┌б╝е╕д╪└┌дъ┬╪дид▐д╣длбй<br />╦▄╚╓е┌б╝е╕д╪└┌дъ┬╪дид╧бв╜╜╩мд╦е╞е╣е╚дЄд╖д╞длдщ╣╘д├д╞дпд└д╡ддбг', '6', '2', 'zen_cfg_select_option(array(\'True\', \'False\'), ', now())");
      $db->Execute("insert into " . TABLE_CONFIGURATION . " (configuration_title, configuration_key, configuration_value, configuration_description, configuration_group_id, sort_order, date_added) values ('▓├╠┴┼╣е│б╝е╔', 'MODULE_PAYMENT_KURONEKO_AT_PAYMENT_TRADER_CODE', '', '▓├╠┴┼╣е│б╝е╔', '6', '3', now())");
      $db->Execute("insert into " . TABLE_CONFIGURATION . " (configuration_title, configuration_key, configuration_value, configuration_description, configuration_group_id, sort_order, date_added) values ('║╟─у╢т│█', 'MODULE_PAYMENT_KURONEKO_AT_PAYMENT_MINIMUM_TOTAL_PRICE', '0', 'епеэе═е│бўе┌едесеєе╚дЄ┼м═╤д╣ды║╟─у╢т│█дЄ╞■╬╧д╖д╞дпд└д╡ддбг', '6', '4', now())");
      $db->Execute("insert into " . TABLE_CONFIGURATION . " (configuration_title, configuration_key, configuration_value, configuration_description, configuration_group_id, sort_order, date_added) values ('┴ў┐о└шURL', 'MODULE_PAYMENT_KURONEKO_AT_PAYMENT_ACTION_URL', 'https://payment.kuronekoyamato.co.jp/kuroneko/servlet/YCS_ServletC', 'еъеєепе▄е┐еєд╬┴ў┐о└шд╬URLдЄ╗╪─ъд╖д▐д╣бг', '6', '5', now())");
      $db->Execute("insert into " . TABLE_CONFIGURATION . " (configuration_title, configuration_key, configuration_value, configuration_description, configuration_group_id, sort_order, date_added) values ('епеэе═е│бўе┌едесеєе╚еъеєепе╨е╩б╝', 'MODULE_PAYMENT_KURONEKO_AT_PAYMENT_LINK_BANNER', '<a href=\"http://payment.kuronekoyamato.co.jp/help/hanbai/card.html\" target=\"_blank\"><img src=http://payment.kuronekoyamato.co.jp/help/images/payment04.gif width=\"50\" height=\"50\" border=\"0\" alt=\"епеэе═е│бўе┌едесеєе╚\"></a>', 'епеэе═е│бўе┌едесеєе╚еъеєепе╨б╝е╩б╝д╬HTMLе╜б╝е╣дЄ╞■╬╧д╖д╞дпд└д╡ддбг', '6', '6', now())");
      $db->Execute("insert into " . TABLE_CONFIGURATION . " (configuration_title, configuration_key, configuration_value, configuration_description, configuration_group_id, sort_order, use_function, set_function, date_added) values ('┼м═╤├╧░ш', 'MODULE_PAYMENT_KURONEKO_AT_PAYMENT_ZONE', '2', '╔мд║╞№╦▄дЄ┴к┬Єд╖д╞дпд└д╡ддбг<br />епеэе═е│бўе┌едесеєе╚д╧╞№╦▄╣ё│░д╟д╧═°═╤д╟днд▐д╗дєбг', '6', '7', 'zen_get_zone_class_title', 'zen_cfg_pull_down_zone_classes(', now())");
      $db->Execute("insert into " . TABLE_CONFIGURATION . " (configuration_title, configuration_key, configuration_value, configuration_description, configuration_group_id, sort_order, date_added) values ('╔╜╝ид╬└░╬є╜ч', 'MODULE_PAYMENT_KURONEKO_AT_PAYMENT_SORT_ORDER', '0', '╔╜╝ид╬└░╬є╜чдЄ└▀─ъд╟днд▐д╣бг┐Ї╗·дм╛од╡ддд█д╔╛х░╠д╦╔╜╝ид╡дьд▐д╣бг', '6', '8', now())");
      $db->Execute("insert into " . TABLE_CONFIGURATION . " (configuration_title, configuration_key, configuration_value, configuration_description, configuration_group_id, sort_order, set_function, use_function, date_added) values ('╜щ┤№├э╩╕е╣е╞б╝е┐е╣', 'MODULE_PAYMENT_KURONEKO_AT_PAYMENT_ORDER_STATUS_ID', '0', '└▀─ъд╖д┐е╣е╞б╝е┐е╣дм╝ї├э╗■д╦┼м═╤д╡дьд▐д╣бг', '6', '9', 'zen_cfg_pull_down_order_statuses(', 'zen_get_order_status_name', now())");
   }

    function remove() {
      global $db;
      $db->Execute("delete from " . TABLE_CONFIGURATION . " where configuration_key in ('" . implode("', '", $this->keys()) . "')");
    }

    function keys() {
      return array('MODULE_PAYMENT_KURONEKO_AT_PAYMENT_STATUS', 'MODULE_PAYMENT_KURONEKO_AT_PAYMENT_NO_TEST', 'MODULE_PAYMENT_KURONEKO_AT_PAYMENT_TRADER_CODE', 'MODULE_PAYMENT_KURONEKO_AT_PAYMENT_MINIMUM_TOTAL_PRICE', 'MODULE_PAYMENT_KURONEKO_AT_PAYMENT_ACTION_URL', 'MODULE_PAYMENT_KURONEKO_AT_PAYMENT_LINK_BANNER', 'MODULE_PAYMENT_KURONEKO_AT_PAYMENT_ZONE', 'MODULE_PAYMENT_KURONEKO_AT_PAYMENT_ORDER_STATUS_ID', 'MODULE_PAYMENT_KURONEKO_AT_PAYMENT_SORT_ORDER');
    }
  }

?>
